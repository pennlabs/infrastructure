orgWhitelist: github.com/pennlabs/infrastructure

# Atlantis requires the GitHub app private key to be saved in a file
# This workaround allows us to load it from an environment variable from vault
# Additional flags are also specified here until the helm chart includes them natively
command:
  [
    "/bin/sh",
    "-c",
    'echo "$ATLANTIS_GH_APP_KEY" > /home/atlantis/gh_app_key.pem && atlantis server --silence-vcs-status-no-plans --hide-prev-plan-comments --write-git-creds --gh-app-key-file=/home/atlantis/gh_app_key.pem',
  ]

image:
  repository: runatlantis/atlantis
  tag: v0.14.0
  pullPolicy: IfNotPresent

## Use Server Side Repo Config,
## ref: https://www.runatlantis.io/docs/server-side-repo-config.html
repoConfig: |
  ---
  repos:
    - id: github.com/pennlabs/infrastructure
      apply_requirements: [approved, mergeable]
      workflow: default
      allowed_overrides: [workflow]
      allow_custom_workflows: false
  workflows:
    default:
      plan:
        steps: [init, plan]
      apply:
        steps: [apply]
    base:
      plan:
        steps:
          - run: cd ../chronos
          - run: /atlantis-data/bin/terraform${ATLANTIS_TERRAFORM_VERSION} init -input=false -no-color -upgrade
          - run: /atlantis-data/bin/terraform${ATLANTIS_TERRAFORM_VERSION} refresh -no-color
          - run: cd ../base
          - init
          - plan

defaultTFVersion: 0.12.29

ingress:
  enabled: true
  path: /
  host: atlantis.pennlabs.org
  tls:
    - secretName: pennlabs-org-tls
      hosts:
        - atlantis.pennlabs.org

## test container details
test:
  enabled: true
  image: lachlanevenson/k8s-kubectl
  imageTag: v1.4.8-bash

loadEnvFromSecrets:
  - atlantis
